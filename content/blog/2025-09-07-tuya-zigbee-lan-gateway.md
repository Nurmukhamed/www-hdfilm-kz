---
title: "Tuya Zigbee Lan Gateway - прошиваем и подключаем к HomeAssistant"
date: 2025-09-07T08:50:55+05:00
summary: ""
categories:
- homeassistant
- zigbee
- mqtt
- zigbee2mqtt
- ezsp
- ember
- firmware
- python
- python3
- bellows
- github
---
Как прошить Tuya Zigbee Lan Gateway и подключить к HomeAssistant через zigbee2mqtt.
<!--more-->

# Предыстория

Меня интересует "Умный дом", в частности, реализации на базе Open Source решений, одним из таких является HomeAssistant.

C 2021 года у меня работает шлюз Xiaomi, который круглый и втыкается в розетку. Данное устройство я купил с рук и оно уже было прошито под OpenWRT.
Там я оставил только LumiMQTT, Zigbee2MQTT. А HomeAssistant находится на одном из домашних серверов.

Но весь этот процесс происходит по остаточному принципу, когда появляется свободное время, сажусь, читаю, настраиваю.

Но часто бывает, что просто читаю и ничего не понимаю. Очень уж бываю уставшим.

Также я занимался видеонаблюдением Frigate NVR, об этом даже подготовил [отдельную статью][1]. Связка HomeAssistant, Mosquitto, Frigate, Telegram bot отлично себя показала, работает в полевых условиях уже 3й месяц без замечаний,

Очень хотелось приобрести устройство, которое выполняло только одну задачу - Zigbee. Ну было бы простым и надежным. И такое устройство есть - это [Tuya Zigbee Lan Gateway][2].

И такое одно устройство приобрел, подключил по инструкции к приложению SmartLife. Устройство определилось и работает. Но в облаке Tuya, что меня не устраивает. 

**Устройство должно уметь работать полностью локально.**

Но решение уже есть и о нем будет далее.

# Железо

Шлюз из себя предстваляет систему на базе [Realtek 8196E][3] и [Zigbee устройство][4]. Между собой процессор и плата общаются посредством UART. Также на моем устройстве установлена [EEPROM GD25Q127C][5].

# Полезные ссылки

* [Hacking the LIDL Silvercast Zigbee Gateway a step-by-step tutorial][6]
* [LIDL Zigbee firmware-hacking][7]
* [Hacking Tuya Zigbee Ethernet Gateway][8]
* [Link to Ember V8 firmware][9]
* [Zigbee Ethernet Gateway #2][10]
* [Using the Lidl Livarno Lux Zigbee gateway with Zigbee2MQTT][11]

# Мои приключения

Устройство я купил в сентябре 2024 года. Тогда быстро настроил под SmartLife и на этом остановился. Для подключения к HomeAssistant предлагали следующее решение - установить расширение [Tuya Local][12]. И, кажется, это бы работало уже без самого облака, но я подстчитал, что такое решение не подойдет.

Зимой, я наткнулся на [этот тред][13]. Прочитал бегло и ничего не понял. Тред идет с 2021 года. 

Весной, я наткнулся на [статью Paul Banks][7] о том, как проводить процедуру, как через USB-TTL подключаться и выкачивать образ, затем определить пароль пользователя root. Прочитал, тоже много не понятного. Например, в HomeAssistant нужно устанавливать расширение ZHA. Отложил в беклог.

Летом, еще раз перечитал, узнал новости, в этот раз пазл сложился. Из новостей приятным было узнать, что Zigbee2MQTT включили поддержку EZSP, Ember.

Порядок действии:

* Вскрыть корпус;
* Вытащить плату, аккуратно отсоеденить антенну;
* Припаять 6 пинов на плату;
* Подключить согласно распиновке USB-TTL (у меня CP2102);
* На компьютере запустить команду sudo screen /dev/ttyUSB0 38400;
* Подать питание на плату;
* Нажать ESC как можно быстрее;
* Войти в UBOOT, выкачать к себе на компьютер образ системы;
* На компьтере запустить скрипты и получить пароль пользователя root;
* Перезагрузить плату;
* Войти в консоль под пользователем root, используя полученный пароль;
* Скачать программу serialmonitor на плату;
* Заменить скрипты в /tuya - убрать старый скрипт, добавить новый, который запускает serialmonitor;
* Настроить zigbee2mqtt;
* Настроить HomeAssistant.

Что пошло не так?:

* Производитель изменил UBOOT, теперь нажатие на ESC не прерывает процесс загрузки;
* Попытался считать данные с EEPROM с помощью клипсы - не удалось. Пишут что клипсы не правильные;
* Купил клипсу Pomona, подцепил к чипу - все равно не работает;
* Достал паяльник, выпаял чип, припаял к адаптеру, смог прочитать образ, запаял чип назад, включил вроде работает.

Я плохо пяю, поэтому всячески стараюсь избегать данной операции, но тут прижало, решил быть спокойным, с новым паяльником начал процесс.
Но все равно пошло не по плану, сдул один конденстатор C25, запаял все назад, прочистил изопропиловым спиртом, подключил - работает.

# Мои рекомендации для 2025 года.

## Start Here

Для 2025 я рекомендую [эту статью][11]. Выполните все действия.

## Если ESC не работает

Если ESC не работает, то можно воспользоваться методом, очень осторожно, который описан [здесь][10]. Метод простой - делаем так, чтобы процессор подумал, что флешки нет.
Включается аварийны режим UBOOT, оттуда все можно вытащить.

Или поступить как я, выпаять схему, прочитать ее на программаторе, например, на TL866.

## Как узнать пароль пользователя root, если есть образ под рукой?

Для способа вытащить образ через программатор, то [эта статья][8] будет очень полезной. Я смог так узнать пароль пользователя root от своего устройства.

Рекомендую сперва создать [Python venv][14] окружение, чтобы не засорять систему.

## Переход от V7 к V8 версии EZSP, Ember.

Итак я успешно выполнил все предыдущие действия, устройство доступно, настроен zigbee2mqtt, но zigbee2mqtt не может запустить zigbee стек.

[Статья][11] предлагает нам установить версию прошивки NCP_UHW_MG1B232_678_PA0-PA1-PB11_PA5-PA4.gbl. Таким образом, мы прошиваем версию прошивки на Zigbee платы до V7.

Но современная версия (на момент сентября 2025 года) Zigbee2MQTT требует V8 версию. Эту версию прошивки можно взять [отсюда][9]. Скачиваем, устанавливаем удаленно с помощью скрипта **upgrade_ncp.py**, изменяем конфигурацию Zigbee2MQTT на следующую:

~~~yaml
serial:
  port: tcp://IP:8888
  adapter: ember
  baudrate: 115200
  rtscts: false
~~~

После этого Zigbee2MQTT должен поднятся и работать.

[1]: https://github.com/Nurmukhamed/homeserverfrigate/
[2]: https://aliexpress.ru/item/1005004547056435.html?sku_id=12000029564341740&spm=a2g2w.productlist.search_results.0.400374cc3sM8kD
[3]: https://www.realtek.com/Product/Index?id=408&cate_id=194
[4]: https://developer.tuya.com/en/docs/iot/zigbeetyzs4module?id=K989rhycrz23f
[5]: https://static.chipdip.ru/lib/011/DOC004011760.pdf
[6]: https://community.openhab.org/t/hacking-the-lidl-silvercrest-zigbee-gateway-a-step-by-step-tutorial/129660
[7]: https://paulbanks.org/projects/lidl-zigbee/#firmware-hacking
[8]: https://github.com/parasite85/tuya_dmd2cc_gateway_hack?tab=readme-ov-file
[9]: https://github.com/Koenkk/zigbee2mqtt/discussions/22520#discussioncomment-12282505
[10]: https://blog.david-reid.com/zigbee-ethernet-gateway-2/
[11]: https://alu.dog/posts/livarno-lux/
[12]: https://github.com/make-all/tuya-local
[13]: https://github.com/zigpy/zigpy/discussions/650
[14]: https://docs.python.org/3/library/venv.html
