name: FTP Deploy
on:
  push:
    branches:
      - master  # Set a branch to deploy
    paths:
      - "content/**"
      - "config.toml"
jobs:
  ftp-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: üõí Checkout
        uses: actions/checkout@v3

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2.6.0
        with:
          hugo-version: 'latest'

      - name: Build
        run: hugo --minify

      - name: üì¶ Get LFTP
        run: sudo apt install lftp

      - name: üõ†Ô∏è Configure LFTP
        run: mkdir ~/.lftp && echo "set ssl:verify-certificate false;" >> ~/.lftp/rc

      - name: üîë Load Secrets
        run: echo "machine ${{ secrets.FTP_HOSTNAME }} login ${{ secrets.FTP_USERNAME }} password ${{ secrets.FTP_PASSWORD }}" > ~/.netrc

      - name: Deploy files via SFTP
        uses: pressidium/lftp-mirror-action@v1
        with:
          # SFTP credentials
          host: ${{ secrets.FTP_HOSTNAME }}
          #port: ${{ secrets.SFTP_PORT }}
          user: ${{ secrets.FTP_USERNAME }}
          pass: ${{ secrets.FTP_PASSWORD }}
          # lftp settings
          onlyNewer: true
          settings: 'sftp:auto-confirm=yes'
          # Mirror command options
          localDir: './public/'
          remoteDir: '/'
          reverse: true
          ignoreFile: '.lftp_ignore'
          options: '--verbose'

      - name: üìÅ Upload Folder
        run: lftp -e "mirror --parallel=100 -R ./public/ /" ${{ secrets.FTP_HOSTNAME }}