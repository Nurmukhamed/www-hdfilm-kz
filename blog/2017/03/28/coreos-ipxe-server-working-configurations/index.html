<script data-goatcounter=https://stats.hdfilm.kz/count async src=//stats.hdfilm.kz/count.js></script><!doctype html><html lang=ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Решил настроить тестовый кластер coreos с загрузкой по сети."><meta name=theme-color content="#ffcd00"><meta property="og:title" content="COREOS - загрузка по сети • Нұрмұхамед Артықалы"><meta property="og:description" content="Решил настроить тестовый кластер coreos с загрузкой по сети."><meta property="og:url" content="https://www.hdfilm.kz/blog/2017/03/28/coreos-ipxe-server-working-configurations/"><meta property="og:site_name" content="Нұрмұхамед Артықалы"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2017-03-28T00:00:00Z"><meta property="article:modified_time" content="2017-03-28T00:00:00Z"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.111.3"><title>COREOS - загрузка по сети • Нұрмұхамед Артықалы</title><link rel=canonical href=https://www.hdfilm.kz/blog/2017/03/28/coreos-ipxe-server-working-configurations/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.6a060eb7.css><link rel=stylesheet href=/css/custom.css><style>:root{--color-accent:#ffcd00}</style></head><body class='page type-blog layout-page has-sidebar'><div class=site><div id=sidebar class=sidebar><a class=screen-reader-text href=#main-menu></a><div class=container><section class='widget widget-about sep-after'><header><div class=logo><a href=/><img src=/images/logo.png></a></div><h2 class='title site-title'><a href=/>Нұрмұхамед Артықалы</a></h2><div class=desc>Нұрмұхамед Артықалы - IT-инженер, сисадмин, программист, DevOps, SRE. Изучает новые технологии и занимается борьбой. Блог посвящен IT технологиям и (или) событиями, связанными с IT в Казахстане, СНГ и в мире.</div></header></section><section class='widget widget-search sep-after'><header><h4 class='title widget-title'>Search</h4></header><form action=/search id=search-form class=search-form><label><span class=screen-reader-text></span>
<input id=search-term class=search-term type=search name=q placeholder=&mldr;></label></form></section><section class='widget widget-taxonomy_cloud sep-after'><header><h4 class='title widget-title'></h4></header><div class='container list-container'><ul class='list taxonomy-cloud'><span></span></ul></div></section></div><div class=sidebar-overlay></div></div><div class=main><nav id=main-menu class='menu main-menu' aria-label><div class=container><a class=screen-reader-text href=#content></a>
<button id=sidebar-toggler class=sidebar-toggler aria-controls=sidebar>
<span class=screen-reader-text></span>
<span class=open><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></span><span class=close><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button><ul><li class=item><a href=/about.md>About</a></li><li class=item><a href=/blog/>Blog</a></li><li class=item><a href=/coreos/>CoreOS</a></li><li class=item><a href=/kubernetes/>Kubernetes</a></li><li class=item><a href=https://github.com/Nurmukhamed/www-hdfilm-kz-octopress>Repo</a></li><li class=item><a href=/cv.pdf>Резюме</a></li></ul></div></nav><div class=header-widgets><div class=container></div></div><header id=header class='header site-header'><div class='container sep-after'><div class=header-info><p class='site-title title'>Нұрмұхамед Артықалы</p><p class='desc site-desc'>Нұрмұхамед Артықалы - IT-инженер, сисадмин, программист, DevOps, SRE. Изучает новые технологии и занимается борьбой. Блог посвящен IT технологиям и (или) событиями, связанными с IT в Казахстане, СНГ и в мире.</p></div></div></header><main id=content><article lang=ru class=entry><header class='header entry-header'><div class='container sep-after'><div class=header-info><h1 class=title>COREOS - загрузка по сети</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text></span><time class=entry-date datetime=2017-03-28T00:00:00Z>2017, Mar 28</time></span>
<span class=reading-time><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg></span></div></div></header><div class='container entry-content'><p>Решил настроить тестовый кластер coreos с загрузкой по сети.</p><p><strong>UPDATE: 31-03-2017:</strong> Изменил скрипт поиска обновлений CoreOS.</p><p><strong>Используемые инструменты</strong>:</p><ul><li>домашний сервер CentOS 7</li><li>libvirtd</li><li>coreos 1205</li><li>coreos-ipxe-server</li><li>etcd2</li></ul><p><strong>Задача</strong>:</p><ul><li>Загрузить тестовый кластер по сети;</li><li>Делать разбивку диска при загрузке;</li><li>Создать нового пользователя и его окружение.</li></ul><h3 id=настройка-libvirtd><strong>Настройка libvirtd</strong></h3><p>Все виртуальные машины используют сеть по умолчанию в режиме nat, внес изменения в сеть default, закрепил адреса к макадресам виртуальных машин.</p><pre tabindex=0><code>sudo virsh net-edit default

&lt;network&gt;
  &lt;name&gt;default&lt;/name&gt;
  &lt;uuid&gt;4b147bf4-7496-4351-acdb-f957fd20d38c&lt;/uuid&gt;
  &lt;forward mode=&#39;nat&#39;/&gt;
  &lt;bridge name=&#39;virbr0&#39; stp=&#39;on&#39; delay=&#39;0&#39;/&gt;
  &lt;mac address=&#39;52:54:00:05:d1:18&#39;/&gt;
  &lt;dns&gt;
    &lt;forwarder addr=&#39;192.168.10.2&#39;/&gt;
  &lt;/dns&gt;
  &lt;ip address=&#39;192.168.122.1&#39; netmask=&#39;255.255.255.0&#39;&gt;
    &lt;dhcp&gt;
      &lt;range start=&#39;192.168.122.100&#39; end=&#39;192.168.122.254&#39;/&gt;
      &lt;host mac=&#39;52:54:00:55:1c:ee&#39; name=&#39;a-coreos&#39; ip=&#39;192.168.122.2&#39;/&gt;
      &lt;host mac=&#39;52:54:00:47:51:e4&#39; name=&#39;b-coreos&#39; ip=&#39;192.168.122.3&#39;/&gt;
      &lt;host mac=&#39;52:54:00:81:ac:aa&#39; name=&#39;c-coreos&#39; ip=&#39;192.168.122.4&#39;/&gt;
    &lt;/dhcp&gt;
  &lt;/ip&gt;
&lt;/network&gt;
</code></pre><p>Виртуальные машины грузятся только по сети. Ниже конфигурация машины a.coreos</p><pre tabindex=0><code>&lt;domain type=&#39;kvm&#39;&gt;
  &lt;name&gt;a.coreos&lt;/name&gt;
  &lt;uuid&gt;c6c30f6a-4a1b-4337-8325-c4c2543ad437&lt;/uuid&gt;
  &lt;memory unit=&#39;KiB&#39;&gt;1048576&lt;/memory&gt;
  &lt;currentMemory unit=&#39;KiB&#39;&gt;1048576&lt;/currentMemory&gt;
  &lt;vcpu placement=&#39;static&#39;&gt;1&lt;/vcpu&gt;
  &lt;os&gt;
    &lt;type arch=&#39;x86_64&#39; machine=&#39;pc-i440fx-rhel7.0.0&#39;&gt;hvm&lt;/type&gt;
    &lt;boot dev=&#39;network&#39;/&gt;
  &lt;/os&gt;
  &lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
  &lt;/features&gt;
  &lt;cpu mode=&#39;custom&#39; match=&#39;exact&#39;&gt;
    &lt;model fallback=&#39;allow&#39;&gt;Penryn&lt;/model&gt;
  &lt;/cpu&gt;
  &lt;clock offset=&#39;utc&#39;&gt;
    &lt;timer name=&#39;rtc&#39; tickpolicy=&#39;catchup&#39;/&gt;
    &lt;timer name=&#39;pit&#39; tickpolicy=&#39;delay&#39;/&gt;
    &lt;timer name=&#39;hpet&#39; present=&#39;no&#39;/&gt;
  &lt;/clock&gt;
  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;
  &lt;on_crash&gt;restart&lt;/on_crash&gt;
  &lt;pm&gt;
    &lt;suspend-to-mem enabled=&#39;no&#39;/&gt;
    &lt;suspend-to-disk enabled=&#39;no&#39;/&gt;
  &lt;/pm&gt;
  &lt;devices&gt;
    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;
    &lt;disk type=&#39;file&#39; device=&#39;disk&#39;&gt;
      &lt;driver name=&#39;qemu&#39; type=&#39;raw&#39;/&gt;
      &lt;source file=&#39;/storage/iscsi/a.coreos.img&#39;/&gt;
      &lt;target dev=&#39;hda&#39; bus=&#39;ide&#39;/&gt;
      &lt;address type=&#39;drive&#39; controller=&#39;0&#39; bus=&#39;0&#39; target=&#39;0&#39; unit=&#39;0&#39;/&gt;
    &lt;/disk&gt;
    &lt;controller type=&#39;scsi&#39; index=&#39;0&#39; model=&#39;virtio-scsi&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x04&#39; function=&#39;0x0&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-ehci1&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x06&#39; function=&#39;0x7&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci1&#39;&gt;
      &lt;master startport=&#39;0&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x06&#39; function=&#39;0x0&#39; multifunction=&#39;on&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci2&#39;&gt;
      &lt;master startport=&#39;2&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x06&#39; function=&#39;0x1&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;usb&#39; index=&#39;0&#39; model=&#39;ich9-uhci3&#39;&gt;
      &lt;master startport=&#39;4&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x06&#39; function=&#39;0x2&#39;/&gt;
    &lt;/controller&gt;
    &lt;controller type=&#39;pci&#39; index=&#39;0&#39; model=&#39;pci-root&#39;/&gt;
    &lt;controller type=&#39;ide&#39; index=&#39;0&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x01&#39; function=&#39;0x1&#39;/&gt;
    &lt;/controller&gt;
    &lt;interface type=&#39;bridge&#39;&gt;
      &lt;mac address=&#39;52:54:00:55:1c:ee&#39;/&gt;
      &lt;source bridge=&#39;virbr0&#39;/&gt;
      &lt;model type=&#39;virtio&#39;/&gt;
      &lt;rom bar=&#39;on&#39; file=&#39;/usr/share/ipxe/coreos/a/virtio-net.rom&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x03&#39; function=&#39;0x0&#39;/&gt;
    &lt;/interface&gt;
    &lt;serial type=&#39;pty&#39;&gt;
      &lt;target port=&#39;0&#39;/&gt;
    &lt;/serial&gt;
    &lt;console type=&#39;pty&#39;&gt;
      &lt;target type=&#39;serial&#39; port=&#39;0&#39;/&gt;
    &lt;/console&gt;
    &lt;input type=&#39;mouse&#39; bus=&#39;ps2&#39;/&gt;
    &lt;input type=&#39;keyboard&#39; bus=&#39;ps2&#39;/&gt;
    &lt;video&gt;
      &lt;model type=&#39;cirrus&#39; vram=&#39;16384&#39; heads=&#39;1&#39; primary=&#39;yes&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x02&#39; function=&#39;0x0&#39;/&gt;
    &lt;/video&gt;
    &lt;memballoon model=&#39;virtio&#39;&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x05&#39; function=&#39;0x0&#39;/&gt;
    &lt;/memballoon&gt;
  &lt;/devices&gt;
&lt;/domain&gt;
</code></pre><p>Для каждой виртуальной машины был собран свой образ ipxe для сетевой карты.
Вот настройки сетевой карты для a.coreos</p><pre tabindex=0><code>    &lt;interface type=&#39;bridge&#39;&gt;
      &lt;mac address=&#39;52:54:00:55:1c:ee&#39;/&gt;
      &lt;source bridge=&#39;virbr0&#39;/&gt;
      &lt;model type=&#39;virtio&#39;/&gt;
      &lt;rom bar=&#39;on&#39; file=&#39;/usr/share/ipxe/coreos/a/virtio-net.rom&#39;/&gt;
      &lt;address type=&#39;pci&#39; domain=&#39;0x0000&#39; bus=&#39;0x00&#39; slot=&#39;0x03&#39; function=&#39;0x0&#39;/&gt;
    &lt;/interface&gt;
</code></pre><p>Соберем образ ipxe для виртуальной машины a.coreos</p><pre tabindex=0><code>cd /usr/src/ipxe/src

cat menu.ipxe
#!ipxe
dhcp
chain http://192.168.122.1:4777?profile=c-coreos

make clean
make EMBED=menu.ipxe bin/virtio-net.rom

mkdir -p /usr/share/ipxe/coreos/{a,b,c}
mv bin/virtio-net.rom /usr/share/ipxe/coreos/a/virtio-net.rom
</code></pre><h3 id=coreos-ipxe-server><strong>Coreos-ipxe-server</strong></h3><p>Я использую <a href=https://github.com/kelseyhightower/coreos-ipxe-server>coreos-ipxe-server</a> для загрузки по сети конфигурации для coreos-машин</p><pre tabindex=0><code>mkdir -p ${GOPATH}/src/github.com/kelseyhightower
cd ${GOPATH}/src/github.com/kelseyhightower
git clone git@github.com:kelseyhightower/coreos-ipxe-server.git

cd ${GOPATH}/src/github.com/kelseyhightower/coreos-ipxe-server
go build .

mkdir -p /opt/coreos-ipxe-server/{configs,images,profiles,sshkeys}
cp coreos-ipxe-server /opt/coreos-ipxe-server

cat &lt;&lt;EOF &gt; /etc/systemd/system/coreos-ipxe-server.service
[Unit]
Description=coreos-ipxe-server service
After=libvirtd.service

[Service]
Type=simple
Environment=COREOS_IPXE_SERVER_BASE_URL=coreos-ipxe.nurm.local:4777

ExecStart=/opt/coreos-ipxe-server/coreos-ipxe-server
KillSignal=SIGINT
Restart=on-failure
RestartSec=30

[Install]
WantedBy=multi-user.target
EOF

systemctl enable coreos-ipxe-server
systemctl start coreos-ipxe-server
</code></pre><p>Время от времени нужно проверять текущую версию Coreos. я написал небольшой скрипт, который:</p><ul><li>проверяет текущую версию на сайте;</li><li>изменяет версии во всех профайлах;</li><li>скачивает последние версии на сервер.</li></ul><p>Закинул данный файл в /etc/cron.daily/</p><pre tabindex=0><code>#!/bin/bash

curl http://stable.release.core-os.net/amd64-usr/current/coreos_production_pxe.sh -o /tmp/coreos-current-version.sh

left=$(cat /tmp/coreos-current-version.sh | grep &#34;VM_NAME&#34; | grep &#34;coreos_production&#34;| cut -d &#34;=&#34; -f 2 | cut -d &#39;-&#39; -f 2)
center=$(cat /tmp/coreos-current-version.sh | grep &#34;VM_NAME&#34; | grep &#34;coreos_production&#34; | cut -d &#34;=&#34; -f 2 | cut -d &#39;-&#39; -f 3)
right=$(cat /tmp/coreos-current-version.sh | grep &#34;VM_NAME&#34; | grep &#34;coreos_production&#34; | cut -d &#34;=&#34; -f 2 | cut -d &#39;-&#39; -f 4 | sed &#34;s/&#39;//&#34;)

CURRENT_RELEASE_VERSION=$(echo ${left}.${center}.${right})
echo ${CURRENT_RELEASE_VERSION}

echo &#34;start circle&#34;

for profile in $(ls /opt/coreos-ipxe-server/profiles); do
    USED_RELEASE_VERSION=$(cat /opt/coreos-ipxe-server/profiles/${profile} | jq &#39;.version&#39; | sed &#39;s/\&#34;//g&#39;)
    echo ${USED_RELEASE_VERSION}

    if [ &#34;${USED_RELEASE_VERSION}&#34; != &#34;${CURRENT_RELEASE_VERSION}&#34; ]; then
        echo &#34;used release version dont match with current release version from website&#34;
        sed -i &#34;s/${USED_RELEASE_VERSION}/${CURRENT_RELEASE_VERSION}/&#34; /opt/coreos-ipxe-server/profiles/${profile}
    fi
done

if [ ! -d &#34;/opt/coreos-ipxe-server/images/amd64-usr/${CURRENT_RELEASE_VERSION}&#34; ]; then
   mkdir -p /opt/coreos-ipxe-server/images/amd64-usr/${CURRENT_RELEASE_VERSION}
fi

if [ ! -f /opt/coreos-ipxe-server/images/amd64-usr/${CURRENT_RELEASE_VERSION}/coreos_production_pxe.vmlinuz ]; then
   curl -o /opt/coreos-ipxe-server/images/amd64-usr/${CURRENT_RELEASE_VERSION}/coreos_production_pxe.vmlinuz http://stable.release.core-os.net/amd64-usr/${CURRENT_RELEASE_VERSION}/coreos_production_pxe.vmlinuz
fi

if [ ! -f /opt/coreos-ipxe-server/images/amd64-usr/${CURRENT_RELEASE_VERSION}/coreos_production_pxe_image.cpio.gz ]; then
   curl -o /opt/coreos-ipxe-server/images/amd64-usr/${CURRENT_RELEASE_VERSION}/coreos_production_pxe_image.cpio.gz http://stable.release.core-os.net/amd64-usr/${CURRENT_RELEASE_VERSION}/coreos_production_pxe_image.cpio.gz
fi
</code></pre><p>Создаем профили для виртуальных машин</p><pre tabindex=0><code>[nurmukhamed@corei3 coreos-ipxe-server]$ cat profiles/a-coreos.json 
{
    &#34;cloud_config&#34;: &#34;a-cloud-config&#34;,
    &#34;rootfstype&#34;: &#34;btrfs&#34;,
    &#34;sshkey&#34;: &#34;nurmukhamed&#34;,
    &#34;version&#34;: &#34;1298.6.0&#34;
}
[nurmukhamed@corei3 coreos-ipxe-server]$ cat profiles/b-coreos.json 
{
    &#34;cloud_config&#34;: &#34;b-cloud-config&#34;,
    &#34;rootfstype&#34;: &#34;btrfs&#34;,
    &#34;sshkey&#34;: &#34;nurmukhamed&#34;,
    &#34;version&#34;: &#34;1298.6.0&#34;
}
[nurmukhamed@corei3 coreos-ipxe-server]$ cat profiles/c-coreos.json 
{
    &#34;cloud_config&#34;: &#34;c-cloud-config&#34;,
    &#34;rootfstype&#34;: &#34;btrfs&#34;,
    &#34;sshkey&#34;: &#34;nurmukhamed&#34;,
    &#34;version&#34;: &#34;1298.6.0&#34;
}
</code></pre><p>Просмотр конфигурации для a-coreos. Что делает данная конфигурация:</p><ul><li>Задает имя сервера;</li><li>Создает нового пользователя nurmukhamed;</li><li>Добавляет пользователя nurmukhamed в группы sudo, docker;</li><li>Задает ssh-ключ для авторизации;</li><li>Создает файл /home/nurmukhamed/.bashrc, где задаются алиасы и полезные утилиты;</li><li>Производит очистку жесткого диска, разбиение диска на два раздела;</li><li>Производит форматирование разделов, подключает разделы к /var/lib/docker, /var/lib/rkt;</li><li>Настраивает сервер для работы с etcd2 сервисом, на сервере CentOS.</li></ul><pre tabindex=0><code>#cloud-config
hostname: a-coreos.nurm.local
users:
  - name: nurmukhamed
    groups:
      - sudo
      - docker
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDnnMkmWq5JNNn/cEx0WyRO330OAmlvWeVwrite-files:
  - path: /home/nurmukhamed/.bashrc
    permissions: &#39;0644&#39;
    content: |
      # .bashrc
      
      # Source global definitions
      if [ -f /etc/bashrc ]; then
        ./etc/bashrc
      fi
      
      alias systemctl=&#39;sudo systemctl&#39;
      alias svim=&#39;sudo vim&#39;
      alias list-units=&#39;sudo fleetctl list-units&#39;
      alias list-machines=&#39;sudo fleetctl list-machines&#39;
      alias list-unit-files=&#39;sudo fleetctl list-unit-files&#39;
      
      service_del() {
        sudo fleetctl stop &#34;$@&#34;
        sudo fleetctl unload &#34;$@&#34;
        sudo fleetctl destroy &#34;$@&#34;
        
      }
      service_add() {
        sudo fleetctl submit &#34;$@&#34;
        sudo fleetctl load &#34;$@&#34;
        sudo fleetctl start &#34;$@&#34;
      }
      
      sprunge() {
        if [[ $1 ]]; then
          curl -F &#39;sprunge=&lt;-&#39; &#34;http://sprunge.us&#34; &lt;&#34;$1&#34;
        else
          curl -F &#39;sprunge=&lt;-&#39; &#34;http://sprunge.us&#34;
        fi
      }
coreos:
  units:
    - name: format-ephemeral.service
      command: start
      content: |
        [Unit]
        Description=Formats the ephemeral drive
        After=dev-sda.device
        Requires=dev-sda.device
        Before=docker.service
        Before=fleet.service
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/sbin/wipefs -f /dev/sda
        ExecStart=/usr/sbin/parted -s /dev/sda mklabel gpt
        ExecStart=/usr/sbin/parted -s /dev/sda mkpart primary ext4 0 9614
        ExecStart=/usr/sbin/parted -s /dev/sda mkpart primary ext4 9615 19229
        ExecStart=/usr/sbin/mkfs.ext4 -F /dev/sda1
        ExecStart=/usr/sbin/mkfs.ext4 -F /dev/sda2
    - name: var-lib-docker.mount
      command: start
      content: |
        [Unit]
        Description=Mount ephemeral to /var/lib/docker
        Requires=format-ephemeral.service
        After=format-ephemeral.service
        Before=docker.service
        [Mount]
        What=/dev/sda1
        Where=/var/lib/docker
        Type=ext4
    - name: var-lib-rkt.mount
      command: start
      content: |
        [Unit]
        Description=Mount ephemeral to /var/lib/rkt
        Requires=format-ephemeral.service
        After=format-ephemeral.service
        Before=fleet.service
        [Mount]
        What=/dev/sda2
        Where=/var/lib/rkt
        Type=ext4
    - name: docker.service
      command: start
    - name: fleet.service
      command: start
  fleet:
    etcd_servers: &#34;http://coreos-ipxe.nurm.local:2379&#34;
  locksmith:
    endpoint: &#34;http://coreos-ipxe.nurm.local:2379&#34;
</code></pre><h3 id=настройка-dnsmasq><strong>Настройка dnsmasq</strong></h3><pre tabindex=0><code>cat /etc/dnsmasq.d/addresses.conf
address=/coreos-ipxe.nurm.local/192.168.122.1
address=/a-coreos.nurm.local/192.168.122.2
address=/b-coreos.nurm.local/192.168.122.3
address=/c-coreos.nurm.local/192.168.122.4
srv-host=_etcd-server._tcp.nurm.local,coreos-ipxe.nurm.local,2380,1
srv-host=_etcd-client._tcp.nurm.local,coreos-ipxe.nurm.local,2380,1
</code></pre><h3 id=настройка-etcd2><strong>Настройка ETCD2</strong></h3><pre tabindex=0><code>cat /etc/etcd/etcd.conf
# [member]
ETCD_NAME=default
ETCD_DATA_DIR=&#34;/var/lib/etcd/default.etcd&#34;
#ETCD_WAL_DIR=&#34;&#34;
#ETCD_SNAPSHOT_COUNT=&#34;10000&#34;
#ETCD_HEARTBEAT_INTERVAL=&#34;100&#34;
#ETCD_ELECTION_TIMEOUT=&#34;1000&#34;
ETCD_LISTEN_PEER_URLS=&#34;http://192.168.122.1:2380&#34;
#ETCD_LISTEN_CLIENT_URLS=&#34;http://coreos-ipxe.nurm.local:2379&#34;
#ETCD_MAX_SNAPSHOTS=&#34;5&#34;
#ETCD_MAX_WALS=&#34;5&#34;
#ETCD_CORS=&#34;&#34;
ETCD_LISTEN_CLIENT_URLS=&#34;http://0.0.0.0:2379,http://0.0.0.0:4001&#34;
#ETCD_ADVERTISE_CLIENT_URLS=&#34;http://coreos-ipxe.nurm.local:2379&#34;
#
#[cluster]
ETCD_INITIAL_ADVERTISE_PEER_URLS=&#34;http://coreos-ipxe.nurm.local:2380&#34;
# if you use different ETCD_NAME (e.g. test), set ETCD_INITIAL_CLUSTER value for this name, i.e. &#34;test=http://...&#34;
#ETCD_INITIAL_CLUSTER=&#34;default=http://localhost:2380&#34;
#ETCD_INITIAL_CLUSTER_STATE=&#34;new&#34;
#ETCD_INITIAL_CLUSTER_TOKEN=&#34;etcd-cluster-1&#34;
ETCD_ADVERTISE_CLIENT_URLS=&#34;http://coreos-ipxe.nurm.local:2379&#34;
#ETCD_DISCOVERY=&#34;&#34;
#ETCD_DISCOVERY_SRV=&#34;nurm.local&#34;
#ETCD_DISCOVERY_FALLBACK=&#34;proxy&#34;
#ETCD_DISCOVERY_PROXY=&#34;&#34;
#
#[proxy]
#ETCD_PROXY=&#34;off&#34;
#ETCD_PROXY_FAILURE_WAIT=&#34;5000&#34;
#ETCD_PROXY_REFRESH_INTERVAL=&#34;30000&#34;
#ETCD_PROXY_DIAL_TIMEOUT=&#34;1000&#34;
#ETCD_PROXY_WRITE_TIMEOUT=&#34;5000&#34;
#ETCD_PROXY_READ_TIMEOUT=&#34;0&#34;
#
#[security]
#ETCD_CERT_FILE=&#34;&#34;
#ETCD_KEY_FILE=&#34;&#34;
#ETCD_CLIENT_CERT_AUTH=&#34;false&#34;
#ETCD_TRUSTED_CA_FILE=&#34;&#34;
#ETCD_PEER_CERT_FILE=&#34;&#34;
#ETCD_PEER_KEY_FILE=&#34;&#34;
#ETCD_PEER_CLIENT_CERT_AUTH=&#34;false&#34;
#ETCD_PEER_TRUSTED_CA_FILE=&#34;&#34;
#
#[logging]
#ETCD_DEBUG=&#34;false&#34;
# examples for -log-package-levels etcdserver=WARNING,security=DEBUG
#ETCD_LOG_PACKAGE_LEVELS=&#34;&#34;
</code></pre><h3 id=настройка-ssh-клиента><strong>Настройка ssh-клиента</strong></h3><p>Также требуется внести изменения в работе ssh-клиента. При каждой загрузке виртуальной машины, сервер coreos генерирует новые ssh-ключи, нужно научить ssh-клиента не обращать на это внимание.</p><pre tabindex=0><code>Host a-coreos
    Hostname a-coreos.nurm.local
    User nurmukhamed
    StrictHostKeyChecking no

Host b-coreos
    Hostname b-coreos.nurm.local
    User nurmukhamed
    StrictHostKeyChecking no

Host c-coreos
    Hostname c-coreos.nurm.local
    User nurmukhamed
    StrictHostKeyChecking no
</code></pre><h3 id=итоги>Итоги</h3><p>Данная конфигурация рабочая, после запуска 3х серверов, получаем рабочий кластер coreos.</p></div><footer class=entry-footer><div class='container sep-before'><div class=categories><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>categories: </span><a class=category href=/blog/category/coreos/>coreos</a>, <a class=category href=/blog/category/ipxe/>ipxe</a>, <a class=category href=/blog/category/libvirtd/>libvirtd</a>, <a class=category href=/blog/category/qemu/>qemu</a>, <a class=category href=/blog/category/etcd2/>etcd2</a></div></div></footer></article><nav class=entry-nav><div class=container><div class='prev-entry sep-before'><a href=/blog/2017/03/21/winter-cinema-report/><span aria-hidden=true><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg></span><span class=screen-reader-text>: </span>Разное - сколько фильмов успел посмотреть за зиму</a></div><div class='next-entry sep-before'><a href=/blog/2017/04/04/run-kubernetes-on-coreos-cluster/><span class=screen-reader-text>: </span>Запускаем Kubernetes на кластере CoreOS<span aria-hidden=true><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav><section id=comments class=comments><div class='container sep-before'><div class=comments-area><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//hdfilm-2.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></section></main><footer id=footer class=footer><div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label><ul><li><a href=https://github.com/Nurmukhamed target=_blank rel=noopener><span class=screen-reader-text></span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=mailto:nurmukhamed.artykaly@hdfilm.kz target=_blank rel=noopener><span class=screen-reader-text></span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://t.me/nartykaly target=_blank rel=noopener><span class=screen-reader-text></span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="m22.05 1.577c-.393-.016-.784.08-1.117.235-.484.186-4.92 1.902-9.41 3.64-2.26.873-4.518 1.746-6.256 2.415C3.53 8.537 2.222 9.035 2.153 9.059c-.46.16-1.082.362-1.61.984-.79581202 1.058365.21077405 1.964825 1.004 2.499 1.76.564 3.58 1.102 5.087 1.608.556 1.96 1.09 3.927 1.618 5.89.174.394.553.54.944.544l-.002.02s.307.03.606-.042c.3-.07.677-.244 1.02-.565.377-.354 1.4-1.36 1.98-1.928l4.37 3.226.035.02s.484.34 1.192.388c.354.024.82-.044 1.22-.337.403-.294.67-.767.795-1.307.374-1.63 2.853-13.427 3.276-15.38L23.676 4.725C23.972 3.625 23.863 2.617 23.18 2.02 22.838 1.723 22.444 1.593 22.05 1.576z"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2009-2025 Nurmukhamed Artykaly</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.67d669ac.js></script><script src=/js/custom.js></script></body></html>