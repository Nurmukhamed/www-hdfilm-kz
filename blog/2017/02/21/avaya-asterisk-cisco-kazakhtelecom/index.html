<!doctype html><html lang=ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="В данной статье о моем опыте настройки Cisco 2811 в связке с Asterisk и Avaya Defenity. Черновик статьи лежал у меня в течение года. Решил опубликовать сегодня"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Cisco VOIP - учимся писать dialplan, dialpeer • Нұрмұхамед Артықалы"><meta property="og:description" content="В данной статье о моем опыте настройки Cisco 2811 в связке с Asterisk и Avaya Defenity. Черновик статьи лежал у меня в течение года. Решил опубликовать сегодня"><meta property="og:url" content="https://www.hdfilm.kz/blog/2017/02/21/avaya-asterisk-cisco-kazakhtelecom/"><meta property="og:site_name" content="Нұрмұхамед Артықалы"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2017-02-21T00:00:00Z"><meta property="article:modified_time" content="2017-02-21T00:00:00Z"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.2"><title>Cisco VOIP - учимся писать dialplan, dialpeer • Нұрмұхамед Артықалы</title><link rel=canonical href=https://www.hdfilm.kz/blog/2017/02/21/avaya-asterisk-cisco-kazakhtelecom/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.6a060eb7.css><link rel=stylesheet href=/css/custom.css><style>:root{--color-accent:#ffcd00}</style></head><body class="page type-blog layout-page has-sidebar"><div class=site><div id=sidebar class=sidebar><a class=screen-reader-text href=#main-menu></a><div class=container><section class="widget widget-about sep-after"><header><div class=logo><a href=/><img src=/images/logo.png></a></div><h2 class="title site-title"><a href=/>Нұрмұхамед Артықалы</a></h2><div class=desc>Нұрмұхамед Артықалы - IT-инженер, сисадмин, программист, DevOps, SRE. Изучает новые технологии и занимается борьбой. Блог посвящен IT технологиям и (или) событиями, связанными с IT в Казахстане, СНГ и в мире.</div></header></section><section class="widget widget-search sep-after"><header><h4 class="title widget-title">Search</h4></header><form action=/search id=search-form class=search-form><label><span class=screen-reader-text></span><input id=search-term class=search-term type=search name=q placeholder=&mldr;></label></form></section><section class="widget widget-taxonomy_cloud sep-after"><header><h4 class="title widget-title"></h4></header><div class="container list-container"><ul class="list taxonomy-cloud"><span></span></ul></div></section></div><div class=sidebar-overlay></div></div><div class=main><nav id=main-menu class="menu main-menu" aria-label><div class=container><a class=screen-reader-text href=#content></a><button id=sidebar-toggler class=sidebar-toggler aria-controls=sidebar>
<span class=screen-reader-text></span><span class=open><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></span><span class=close><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button><ul><li class=item><a href=/about.md>About</a></li><li class=item><a href=/blog/>Blog</a></li><li class=item><a href=/coreos/>CoreOS</a></li><li class=item><a href=/kubernetes/>Kubernetes</a></li><li class=item><a href=https://github.com/Nurmukhamed/www-hdfilm-kz-octopress>Repo</a></li><li class=item><a href=/cv.pdf>Резюме</a></li></ul></div></nav><div class=header-widgets><div class=container></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Нұрмұхамед Артықалы</p><p class="desc site-desc">Нұрмұхамед Артықалы - IT-инженер, сисадмин, программист, DevOps, SRE. Изучает новые технологии и занимается борьбой. Блог посвящен IT технологиям и (или) событиями, связанными с IT в Казахстане, СНГ и в мире.</p></div></div></header><main id=content><article lang=ru class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Cisco VOIP - учимся писать dialplan, dialpeer</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text></span><time class=entry-date datetime=2017-02-21T00:00:00Z>2017, Feb 21</time></span>
<span class=reading-time><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg></span></div></div></header><div class="container entry-content"><p>В данной статье о моем опыте настройки Cisco 2811 в связке с Asterisk и Avaya Defenity. Черновик статьи лежал у меня в течение года. Решил опубликовать сегодня</p><p>##Предыстория:</p><p>В далеких 2007-2009 годах, в одном офисе стояла АТС Avaya, подключенная Е1-потоком к Казахтелекому. В один день руководство решило, что нужно настроить «железную тетку», голосовую почту, конференции, дешевые тарифы через VOIP-провайдеров. В качестве дешевого решения предложил к АТС подключить Asterisk и на базе Asterisk реализовать умный функционал АТС. В качестве sip-e1-шлюза был выбран роутер Cisco 2811 + 2Е1. В то время я еще не знал, что есть такая замечательная компания <a href=http://www.parabel.ru>Парабел</a>, которая выпускает не дорогие E1-платы для Asteriskа.</p><p><strong><strong>Входные данные:</strong></strong></p><p><strong><strong>Казахтелеком:</strong></strong></p><ul><li>Количество е1-потоков – 1, 30 каналов;</li><li>Количество телефонных номеров – 2;</li><li>Номер – 252525;</li><li>Номер – 363636;</li><li>Plan – national;</li><li>Type – isdn.</li></ul><p><strong><strong>Avaya:</strong></strong></p><ul><li>Количество внутренних линий – 96 (макс);</li><li>Количество потоков е1 – 1;</li></ul><p><strong><strong>Cisco:</strong></strong></p><ul><li>Количество PVDM2-32 – 2;</li><li>Количество потоков е1 – 2;</li></ul><p><strong><strong>Номерной план офиса:</strong></strong></p><ul><li>10ХХ,11XX – номера на АТС Avaya;</li><li>12XX – номера на Asterisk;</li><li>252525 – входящий номер для IVR;</li><li>363636 – входящий номер на ресепшн;</li><li>1ХХ – экстренные и служебные номера Казахтелекома;</li><li>2ХХХХХХ, 3ХХХХХХ – исходящий звонок в город;</li><li>8ХХХХХХХХХХ – исходящий междугородний звонок в РК и РФ;</li><li><ol start=810><li>– исходящий международный звонок.</li></ol></li></ul><p><strong><strong>Задача:</strong></strong></p><p><strong><strong>Настроить Cisco следующим образом:</strong></strong></p><ul><li>При звонке на номер 252525, отправлять звонок на asterisk, на «железную тетку»;</li><li>При звонке на номер 363636, отправлять звонок на avaya, на ресепшн;</li><li>При звонке с АТС на Астериск, отправлять звонок на asterisk;</li><li>При звонке с Asterisk на АТС, отправлять звонок на Avaya;</li><li>При звонке с АТС в город – отправлять звонок на Казахтелеком;</li><li>При звонке с АТС на межгород – отправлять звонки на Asterisk, если Asterisk не доступен, отправлять звонки на Казахтелеком;</li></ul><p><strong><strong>Грабли:</strong></strong></p><ul><li>Основной проблемой было понять, как работают dial-peer в cisco. Чтение google дало основную информацию, но ее было не достаточно;</li><li>В asterisk есть понятие context для транка, любой входящий вызов идет в этот контекст, где происходит обработка звонка. В циске такого понятия нет. Нужно уметь отлавливать входящие звонки;</li><li>В чем различие между calling number (набирающий? номер) и called number(набранный номер);</li></ul><p><strong><strong>Решение:</strong></strong></p><p>В визио составил описание процесса звонка в cisco.</p><span class=caption-wrapper><img class=caption src=https://s3-eu-west-1.amazonaws.com/images.hdfilm.kz/kazakhtelecom-incoming.png alt>
<span class=caption-text></span></span><p>Ниже часть конфиг-файла с циски, рабочий:</p><pre><code>!
isdn switch-type primary-net5
isdn voice-call-failure 0
!
voice-card 0
 no dspfarm
!
voice-card 1
 no dspfarm
!
voice rtp send-recv
!
voice service voip
 allow-connections sip to sip
 fax protocol t38 ls-redundancy 0 hs-redundancy 0 fallback pass-through g711alaw
 sip
!
voice class codec 1
 codec preference 1 g711alaw
 codec preference 2 g711ulaw
!
voice class custom-cptone 100
 dualtone busy
  frequency 430
  cadence 350 350
 dualtone disconnect
  frequency 425 435
  cadence 350 continuous
!
voice translation-rule 1
 rule 1 /^\(.*\)$/ /11111\1/ type any national plan any isdn
!
voice translation-rule 2
 rule 2 /^\(.*\)$/ /22222\1/ type any national plan any isdn
!
voice translation-rule 3
 rule 1 /^33333\(.*\)$/ /\1/ type any national plan any isdn
!
voice translation-rule 4
 rule 1 /^44444\(.*\)$/ /\1/ type any national plan any isdn
!
voice translation-rule 5
 rule 1 // // type any national plan any isdn
!
voice translation-rule 6
 rule 1 /^11111\(.*\)/ /44444\1/ type any national plan any isdn
!
voice translation-rule 7
 rule 1 /^22222\(.*\)/ /33333\1/ type any national plan any isdn
!
voice translation-rule 8
 rule 1 /^11111\(.*\)$/ /\1/ type any national plan any isdn
!
voice translation-rule 9
 rule 1 /^22222\(.*\)$/ /\1/ type any national plan any isdn
!
!
voice translation-profile fromAvaya
 translate calling 5
 translate called 2
!
voice translation-profile fromAvayatoCisco
 translate calling 5
 translate called 9
!
voice translation-profile fromAvayatoTelecom
 translate calling 5
 translate called 7
!
voice translation-profile fromTelecom
 translate calling 5
 translate called 1
!
voice translation-profile fromTelecomtoAvaya
 translate calling 5
 translate called 6
!
voice translation-profile fromTelecomtoCisco
 translate calling 5
 translate called 8
!
voice translation-profile toAvaya
 translate calling 5
 translate called 4
!
voice translation-profile toTelecom
 translate calling 5
 translate called 3
!
controller E1 1/0
 framing NO-CRC4
 pri-group timeslots 1-31
!
controller E1 1/1
 framing NO-CRC4
 pri-group timeslots 1-31
!
interface Serial1/0:15
 no ip address
 encapsulation hdlc
 no logging event link-status
 isdn switch-type primary-net5
 isdn incoming-voice voice
 isdn send-alerting
 isdn bchan-number-order ascending
 isdn sending-complete
 no keepalive
 no cdp enable
!
interface Serial1/1:15
 no ip address
 encapsulation hdlc
 no logging event link-status
 isdn switch-type primary-net5
 isdn protocol-emulate network
 isdn incoming-voice voice
 isdn send-alerting
 isdn sending-complete
 no keepalive
 no cdp enable
!
voice-port 1/0:15
 translation-profile incoming fromTelecom
 translation-profile outgoing toTelecom
 cptone RU
!
voice-port 1/1:15
 translation-profile incoming fromAvaya
 translation-profile outgoing toAvaya
 cptone RU
!
dial-peer voice 100 pots
 incoming called-number 252525
 direct-inward-dial
 port 1/0:15
!
dial-peer voice 101 pots
 incoming called-number 363636
 direct-inward-dial
 port 1/0:15
!
dial-peer voice 102 voip
 destination-pattern 11111252525
 progress_ind progress enable 8
 monitor probe icmp-ping
 session protocol sipv2
 session target ipv4:ASTERISKIP
 dtmf-relay rtp-nte h245-signal h245-alphanumeric
 codec g711alaw
 vad aggressive
!
dial-peer voice 103 pots
 translation-profile outgoing fromTelecomtoAvaya
 destination-pattern 11111363636
 port 1/1:15
 forward-digits all
!
dial-peer voice 104 pots
 incoming called-number 12..
 direct-inward-dial
 port 1/1:15
!
dial-peer voice 105 pots
 incoming called-number [23]......
 direct-inward-dial
 port 1/1:15
!
dial-peer voice 106 pots
 incoming called-number 8T
 direct-inward-dial
 port 1/1:15
!
dial-peer voice 107 voip
 destination-pattern 22222T
 progress_ind progress enable 8
 monitor probe icmp-ping
 session protocol sipv2
 session target ipv4:ASTERISKIP
 dtmf-relay rtp-nte h245-signal h245-alphanumeric
 codec g711alaw
 vad aggressive
!
dial-peer voice 108 pots
 translation-profile outgoing fromAvayatoCisco
 destination-pattern 22222[23]......
 port 1/0:15
 forward-digits all
!
dial-peer voice 109 pots
 incoming called-number [01]..
 direct-inward-dial
 port 1/1:15
!
dial-peer voice 110 pots
 translation-profile outgoing fromAvayatoTelecom
 destination-pattern 22222[01]..
 port 1/0:15
 forward-digits all
!
dial-peer voice 111 voip
 destination-pattern 2222212..
 progress_ind progress enable 8
 monitor probe icmp-ping
 session protocol sipv2
 session target ipv4:ASTERISKIP
 dtmf-relay rtp-nte h245-signal h245-alphanumeric
 codec g711alaw
 vad aggressive
!
dial-peer voice 112 pots
 translation-profile outgoing toAvaya
 destination-pattern 1[01]..
 port 1/1:15
 forward-digits all
!
dial-peer voice 113 pots
 translation-profile outgoing fromAvayatoTelecom
 preference 1
 destination-pattern 22222T
 port 1/0:15
 forward-digits all
!
dial-peer voice 114 voip
 translation-profile outgoing fromAvayatoCisco
 destination-pattern 222228..........
 progress_ind progress enable 8
 monitor probe icmp-ping
 session protocol sipv2
 session target ipv4:ASTERISKIP
 dtmf-relay rtp-nte h245-signal h245-alphanumeric
 codec g711alaw
 vad aggressive
!
dial-peer voice 115 pots
 translation-profile outgoing fromAvayatoTelecom
 preference 1
 destination-pattern 222228..........
 port 1/0:15
 forward-digits all
!
sip-ua
 authentication username cisco password 014356540C5A275E741C195C4D504E472E59217D7B
 retry invite 3
 retry response 3
 retry bye 3
 retry cancel 3
 timers trying 1000
 sip-server ipv4:ASTERISKIP
!
</code></pre><p><strong><strong>TODO</strong></strong>: дописать статью</p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>categories: </span><a class=category href=/blog/category/cisco/>cisco</a>, <a class=category href=/blog/category/avaya-defenity/>avaya defenity</a>, <a class=category href=/blog/category/asterisk/>asterisk</a>, <a class=category href=/blog/category/kazakhtelecom/>Kazakhtelecom</a>, <a class=category href=/blog/category/e1-channel/>E1 channel</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before"><a href=/blog/2017/02/20/diy-my-failes-at-weekend/><span aria-hidden=true><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg></span><span class=screen-reader-text>: </span>Паяльник - 2 неудачи в выходные дни</a></div><div class="next-entry sep-before"><a href=/blog/2017/02/28/how-to-create-dynamic-dns-server/><span class=screen-reader-text>: </span>Реализовано - как реализовать свой динамический днс сервер<span aria-hidden=true><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label><ul><li><a href=https://github.com/Nurmukhamed target=_blank rel=noopener><span class=screen-reader-text></span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=mailto:nurmukhamed.artykaly@hdfilm.kz target=_blank rel=noopener><span class=screen-reader-text></span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://t.me/nartykaly target=_blank rel=noopener><span class=screen-reader-text></span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="m22.05 1.577c-.393-.016-.784.08-1.117.235-.484.186-4.92 1.902-9.41 3.64C9.263 6.325 7.005 7.198 5.267 7.867 3.53 8.537 2.222 9.035 2.153 9.059c-.46.16-1.082.362-1.61.984-.79581202 1.058365.21077405 1.964825 1.004 2.499 1.76.564 3.58 1.102 5.087 1.608.556 1.96 1.09 3.927 1.618 5.89.174.394.553.54.944.544l-.002.02s.307.03.606-.042c.3-.07.677-.244 1.02-.565.377-.354 1.4-1.36 1.98-1.928l4.37 3.226.035.02s.484.34 1.192.388c.354.024.82-.044 1.22-.337.403-.294.67-.767.795-1.307.374-1.63 2.853-13.427 3.276-15.38L23.676 4.725C23.972 3.625 23.863 2.617 23.18 2.02 22.838 1.723 22.444 1.593 22.05 1.576z"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2009-2022 Nurmukhamed Artykaly</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.67d669ac.js></script><script src=/js/custom.js></script></body></html>