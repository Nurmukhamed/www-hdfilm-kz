<!doctype html><html lang=ru><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Настройка Firecracker на CentOS 7"><meta name=theme-color content="#ffcd00"><meta property="og:title" content="Настройка Firecracker на CentOS 7 • Нұрмұхамед Артықалы"><meta property="og:description" content="Настройка Firecracker на CentOS 7"><meta property="og:url" content="https://www.hdfilm.kz/blog/2020/05/18/run-firecracker-at-centos7-machines/"><meta property="og:site_name" content="Нұрмұхамед Артықалы"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-05-18T00:00:00Z"><meta property="article:modified_time" content="2020-05-18T00:00:00Z"><meta name=twitter:card content="summary"><meta name=generator content="Hugo 0.74.2"><title>Настройка Firecracker на CentOS 7 • Нұрмұхамед Артықалы</title><link rel=canonical href=https://www.hdfilm.kz/blog/2020/05/18/run-firecracker-at-centos7-machines/><link rel=icon href=/favicon.ico><link rel=stylesheet href=/assets/css/main.6a060eb7.css><link rel=stylesheet href=/css/custom.css><style>:root{--color-accent:#ffcd00}</style></head><body class="page type-blog layout-page has-sidebar"><div class=site><div id=sidebar class=sidebar><a class=screen-reader-text href=#main-menu></a><div class=container><section class="widget widget-about sep-after"><header><div class=logo><a href=/><img src=/images/logo.png></a></div><h2 class="title site-title"><a href=/>Нұрмұхамед Артықалы</a></h2><div class=desc>Нұрмұхамед Артықалы - IT-инженер, сисадмин, программист, DevOps, SRE. Изучает новые технологии и занимается борьбой. Блог посвящен IT технологиям и (или) событиями, связанными с IT в Казахстане, СНГ и в мире.</div></header></section><section class="widget widget-search sep-after"><header><h4 class="title widget-title">Search</h4></header><form action=/search id=search-form class=search-form><label><span class=screen-reader-text></span><input id=search-term class=search-term type=search name=q placeholder=&mldr;></label></form></section><section class="widget widget-taxonomy_cloud sep-after"><header><h4 class="title widget-title"></h4></header><div class="container list-container"><ul class="list taxonomy-cloud"><span></span></ul></div></section></div><div class=sidebar-overlay></div></div><div class=main><nav id=main-menu class="menu main-menu" aria-label><div class=container><a class=screen-reader-text href=#content></a><button id=sidebar-toggler class=sidebar-toggler aria-controls=sidebar>
<span class=screen-reader-text></span><span class=open><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></span><span class=close><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></button><ul><li class=item><a href=/about.md>About</a></li><li class=item><a href=/blog/>Blog</a></li><li class=item><a href=/coreos/>CoreOS</a></li><li class=item><a href=/kubernetes/>Kubernetes</a></li><li class=item><a href=https://github.com/Nurmukhamed/www-hdfilm-kz-octopress>Repo</a></li><li class=item><a href=/cv.pdf>Резюме</a></li></ul></div></nav><div class=header-widgets><div class=container></div></div><header id=header class="header site-header"><div class="container sep-after"><div class=header-info><p class="site-title title">Нұрмұхамед Артықалы</p><p class="desc site-desc">Нұрмұхамед Артықалы - IT-инженер, сисадмин, программист, DevOps, SRE. Изучает новые технологии и занимается борьбой. Блог посвящен IT технологиям и (или) событиями, связанными с IT в Казахстане, СНГ и в мире.</p></div></div></header><main id=content><article lang=ru class=entry><header class="header entry-header"><div class="container sep-after"><div class=header-info><h1 class=title>Настройка Firecracker на CentOS 7</h1></div><div class=entry-meta><span class=posted-on><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span class=screen-reader-text></span><time class=entry-date datetime=2020-05-18T00:00:00Z>2020, May 18</time></span>
<span class=reading-time><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 15 15"/></svg></span></div></div></header><div class="container entry-content"><p><strong>Настройка Firecracker на CentOS 7</strong></p><p>В этой статье хочу рассказать вам настроить <a href=https://github.com/firecracker-microvm/firecracker/>Firecracker</a> на CentOS 7.</p><p>Firecracker - <em>это технология виртуализации с открытым исходным кодом, предназначенная для создания и управления защищенными, мультитенантными контейнерными и функциональными сервисами, обеспечивающими бессерверные операционные модели. Firecracker запускает рабочие нагрузки в облегченных виртуальных машинах, называемых microVMs, которые сочетают свойства безопасности и изоляции, предоставляемые технологией аппаратной виртуализации, со скоростью и гибкостью контейнеров.</em></p><h2 id=update>UPDATE</h2><ul><li>17-08-2020 - Обновлена версия firecracker - 0.22.0</li><li>13-08-2020 - Обновлен раздел &ldquo;Сборка Debian&rdquo;</li></ul><h2 id=план-работ>План работ</h2><ul><li>Вступительное слово;</li><li>Обсуждение архитекутуры;</li><li>Сборка пакета;</li><li>Сборка ядра;</li><li>Сборка корневой системы;<ul><li>Сборка CentOS;</li><li>Сборка Debian;</li><li>Сборка Ubuntu;</li></ul></li><li>Создание параметризированной службы systemd;</li><li>Шаблон виртуальной машины;</li><li>Настройка сети;</li><li>Настройка firewalld;</li><li>Запуск виртуальной машины;</li><li>Автоматизация действий;</li><li>Примеры:<ul><li>CentOS;</li><li>Debian;</li><li>Ubuntu;</li></ul></li><li>Дальнейшие действия.</li></ul><h2 id=вступительное-слово>Вступительное слово</h2><p><em>АВТОР ПРЕДОСТАВЛЯЕТ СТАТЬЮ “КАК ЕСТЬ” БЕЗ КАКИХ-ЛИБО ГАРАНТИЙ, ЯВНЫХ ИЛИ ПОДРАЗУМЕВАЕМЫХ, ВКЛЮЧАЯ, НО НЕ ОГРАНИЧИВАЯСЬ, ПОДРАЗУМЕВАЕМЫМИ ГАРАНТИЯМИ ТОВАРНОЙ ПРИГОДНОСТИ И ПРИГОДНОСТИ ДЛЯ ОПРЕДЕЛЕННОЙ ЦЕЛИ. ВЕСЬ РИСК, СВЯЗАННЫЙ С КАЧЕСТВОМ И ЭФФЕКТИВНОСТЬЮ СТАТЬИ, ЛЕЖИТ НА ВАС. ЕСЛИ СОДЕРЖАНИЕ СТАТЬИ ОКАЖЕТСЯ НЕВЕРНЫМ, ВЫ БЕРЕТЕ НА СЕБЯ РАСХОДЫ НА ВСЕ НЕОБХОДИМОЕ ОБСЛУЖИВАНИЕ, РЕМОНТ ИЛИ ИСПРАВЛЕНИЕ.</em></p><h2 id=обсуждение-архитекутуры>Обсуждение архитекутуры</h2><p><strong>Firecracker</strong> - это очень простой гипервизор, для запуска виртуальной машины необходимо всего 3 файла:</p><ul><li>Бинарный файл firecracker;</li><li>Специально собранное ядро Linux;</li><li>Сборка корневой системы.</li></ul><p>Данная статья описывает как <em>&ldquo;правильно приготовить&rdquo;</em> firecracker для ОС RHEL/CentOS, в частности для 7 версии. Будут использоваться только стандартные пакеты и утилиты, не будет никаких <em>&ldquo;костылей&rdquo;</em>.</p><p>Для firecracker будет собран пакет RPM, с соблюдением требований, пакет не должен влиять на другие пакеты, затирать / изменять файлы.</p><p>TODO - Планируется внедрение политик Selinux для более безопасной эксплуатации.</p><p>Наше дерево файлов и каталогов:</p><table><thead><tr><th>Путь</th><th>Описание</th><th>TODO</th></tr></thead><tbody><tr><td>/usr/lib/systemd/system/firecracker@.service</td><td>Параметризированная служба systemd</td><td>Сделано</td></tr><tr><td>/etc/firecracker</td><td>Каталог для хранения конфигурации виртуальных машин</td><td>Сделано</td></tr><tr><td>/usr/sbin/firecracker</td><td>Бинарный файл</td><td>Сделано</td></tr><tr><td>/usr/sbin/jailer</td><td>Бинарный файл</td><td>Сделано</td></tr><tr><td>/usr/share/firecracker/scripts</td><td>Каталог для хранения дополнительных скриптов</td><td>Сделано</td></tr><tr><td>/var/lib/firecracker</td><td>Каталог для хранения данных</td><td>Сделано</td></tr><tr><td>/var/lib/firecracker/kernels</td><td>Каталог для хранения ядер Linux</td><td>Сделано</td></tr><tr><td>/var/lib/firecracker/rootfs</td><td>Каталог для хранения корневых систем</td><td>Сделано</td></tr><tr><td>/var/lib/firecracker/microvm</td><td>Каталог для хранения виртуальных машин</td><td>Сделано</td></tr><tr><td>/var/lib/firecracker/metrics</td><td>Каталог для хранения метрик виртуальных машин</td><td>Не сделано</td></tr><tr><td>/var/run/firecracker</td><td>Каталог для socket-файлов</td><td>Сделано</td></tr><tr><td>/var/log/firecracker/</td><td>Каталог для логов</td><td>Сделано</td></tr><tr><td>/etc/selinux</td><td>Каталог для файлов Selinux</td><td>Не сделано</td></tr><tr><td>/etc/firewalld</td><td>Каталог для файлов Firewalld</td><td>Не сделано</td></tr></tbody></table><p>Запуск виртуальных машин будет происходить через параметризированную службу firecracker@.service. Рассмотрим пример, если нам нужно запустить виртуальную машину с именем testcentos, то нам нужны будут:</p><table><thead><tr><th>Тип</th><th>Содержание</th></tr></thead><tbody><tr><td>Служба systemd</td><td><a href=mailto:firecracker@testcentos.service>firecracker@testcentos.service</a></td></tr><tr><td>Файл конфигурации</td><td>/etc/firecracker/testcentos.json</td></tr><tr><td>ROOTFS</td><td>/var/lib/firecracker/microvm/testcentos.ext4</td></tr></tbody></table><h2 id=сборка-пакета>Сборка пакета</h2><p>Предполагаю, что у вас уже настроено рабочее окружение для сборки пакетов. Если нет, то вы можете ознакомится <a href=https://fedoraproject.org/wiki/Using_Mock_to_test_package_builds>здесь</a>, <a href=https://www.easycoding.org/2017/02/22/sobiraem-rpm-pakety-dlya-fedora-v-mock.html>здесь</a> и <a href=https://sites.google.com/site/syscookbook/rhel/rhel-rpm-build>здесь</a>.
Также предполагаю, что у вас уже есть опыт работы с RHEL и работа с пакетами у вас не вызывает трудностей.</p><p>Для сборки пакета нам нужно скачать бинарные файлы с github - <a href=https://github.com/firecracker-microvm/firecracker/releases/download/v0.21.1/firecracker-v0.21.1-x86_64>firecracker</a>, <a href=https://github.com/firecracker-microvm/firecracker/releases/download/v0.21.1/jailer-v0.21.1-x86_64>jailer</a></p><pre><code>wget https://github.com/firecracker-microvm/firecracker/releases/download/v0.21.1/firecracker-v0.21.1-x86_64

mv ./firecracker-v0.21.1-x86_64 ~/rpmbuild/SOURCES/firecracker
chmod a+x ~/rpmbuild/SOURCES/firecracker

wget https://github.com/firecracker-microvm/firecracker/releases/download/v0.21.1/jailer-v0.21.1-x86_64
mv jailer-v0.21.1-x86_64 rpmbuild/SOURCES/jailer
chmod a+x ~/rpmbuild/SOURCES/jailer
</code></pre><p>Создадим параметризированную службу systemd</p><pre><code>cat&lt;&lt;EOF | tee rpmbuild/SOURCES/firecracker@.service
[Unit]
Description=Firecracker starting microvm %I
After=network.target

[Service]
PrivateTmp=true
Type=simple
PIDFile=/var/run/firecracker/%i.pid
ExecStartPre=-/bin/rm /var/run/firecracker/%I.socket
ExecStart=/usr/sbin/firecracker --api-sock /var/run/firecracker/%I.socket --config-file /etc/firecracker/%I.json

[Install]
WantedBy=multi-user.target
EOF
</code></pre><p>Создадим шаблон spec-файл для сборки пакета</p><pre><code>rpmdev-newspec rpmbuild/SPECS/firecracker-binary.spec
</code></pre><p>Шаблон Spec-файла выглядит так:</p><pre><code>Name:           firecracker-binary
Version:
Release:        1%{?dist}
Summary:

License:
URL:
Source0:

BuildRequires:
Requires:

%description


%prep
%setup -q


%build
%configure
make %{?_smp_mflags}


%install
rm -rf $RPM_BUILD_ROOT
%make_install


%files
%doc



%changelog
</code></pre><p>Теперь файл нужно привести к следующему виду:</p><pre><code>Name:           firecracker-binary
Version:        v0.22.0
Release:        1%{?dist}
Summary:        Open source virtualization technology

License:        Apache License 2.0
URL:            https://github.com/firecracker-microvm/firecracker
Source0:        https://github.com/firecracker-microvm/firecracker/releases/download/v0.22.0/firecracker-v0.22.0-x86_64
Source1:        https://github.com/firecracker-microvm/firecracker/releases/download/v0.22.0/jailer-v0.22.0-x86_64
Source2:        firecracker@.service
BuildArch:      x86_64

BuildRequires:  systemd

Requires(post): systemd systemd-sysv chkconfig
Requires(preun): systemd
Requires(postun): systemd

%description
Firecracker is an open source virtualization technology that is purpose-built for creating and managing secure, multi-tenant container and function-based services that provide serverless operational models. Firecracker runs workloads in lightweight virtual machines, called microVMs, which combine the security and isolation properties provided by hardware virtualization technology with the speed and flexibility of containers.

%build

%install

rm -rf %{buildroot}

mkdir -p %{buildroot}%{_sbindir} \
        %{buildroot}%{_var}/lib/firecracker/{kernels,rootfs,microvm,metrics} \
        %{buildroot}%{_var}/run/firecracker \
        %{buildroot}%{_var}/log/firecracker \
        %{buildroot}%{_sysconfdir}/firecracker \
        %{buildroot}%/usr/share/firecracker/scripts

install -d -m 0755 %{buildroot}/etc/firecracker
install -d -m 0755 %{buildroot}/usr/share/firecracker
install -d -m 0755 %{buildroot}/usr/share/firecracker/scripts
install -d -m 0755 %{buildroot}/var/lib/firecracker
install -d -m 0755 %{buildroot}/var/lib/firecracker/kernels
install -d -m 0755 %{buildroot}/var/lib/firecracker/rootfs
install -d -m 0755 %{buildroot}/var/lib/firecracker/microvm
install -d -m 0755 %{buildroot}/var/lib/firecracker/metrics
install -d -m 0755 %{buildroot}/var/run/firecracker
install -d -m 0755 %{buildroot}/var/log/firecracker

install -m 0755 %{SOURCE0} %{buildroot}/%{_sbindir}/firecracker
install -m 0755 %{SOURCE1} %{buildroot}/%{_sbindir}/jailer

mkdir -p %{buildroot}%{_unitdir}
install -m644 %{SOURCE2} %{buildroot}%{_unitdir}

%clean
rm -rf %{buildroot}

%post
%systemd_post firecracker@.service

%preun
%systemd_preun firecracker@.service

%postun
%systemd_postun_with_restart firecracker@.service

%files
%defattr(-,root,root,-)
%dir /etc/firecracker
%dir /usr/share/firecracker
%dir /usr/share/firecracker/scripts
%dir /var/lib/firecracker
%dir /var/lib/firecracker/kernels
%dir /var/lib/firecracker/rootfs
%dir /var/lib/firecracker/microvm
%dir /var/lib/firecracker/metrics
%dir /var/run/firecracker
%dir /var/log/firecracker
%{_sbindir}/firecracker
%{_sbindir}/jailer
%{_unitdir}/firecracker@.service
%doc



%changelog
* Mon May 18 2020 Nurmukhamed Artykaly &lt;nurmukhamed.artykaly@hdfilm.kz&gt; v0.21.1-1
- Initial spec file
* Mon Aug 17 2020 Nurmukhamed Artykaly &lt;nurmukhamed.artykaly@hdfilm.kz&gt; v0.22.0-1
- Updated to v0.22.0

</code></pre><p>Собираем RPM-пакет</p><pre><code>spectool -g -R ~/rpmbuild/SPECS/firecracker-binary.spec
rpmbuild -bs ~/rpmbuild/SPECS/firecracker-binary.spec
sudo mock ~/rpmbuild/SRPMS/firecracker-binary-v0.22.0-1.el7.src.rpm
</code></pre><p>Готовый пакет будет здесь</p><pre><code>ll /var/lib/mock/epel-7-x86_64/result/
total 2800
-rw-rw-r-- 1 root mock    9792 May 18 16:03 build.log
-rw-r--r-- 1 root mock 1850581 May 18 16:03 firecracker-binary-v0.22.0-1.el7.src.rpm
-rw-r--r-- 1 root mock  914196 May 18 16:03 firecracker-binary-v0.22.0-1.el7.x86_64.rpm
-rw-rw-r-- 1 root mock    1568 May 18 16:03 hw_info.log
-rw-rw-r-- 1 root mock   16450 May 18 16:03 installed_pkgs.log
-rw-rw-r-- 1 root mock   56517 May 18 16:03 root.log
-rw-rw-r-- 1 root mock     847 May 18 16:03 state.log
</code></pre><p>Можем установить пакет</p><pre><code>sudo yum localinstall /var/lib/mock/epel-7-x86_64/result/firecracker-binary-v0.22.0-1.el7.x86_64.rpm

</code></pre><p>Теперь созданный пакет можем поместить в локальный репозиторий, поставить цифровую подпись, отслеживать изменения, своевременно обновлять пакеты на машинах.</p><h2 id=сборка-ядра>Сборка ядра</h2><p>Нам понадобится ядро Linux. Варианты:</p><ul><li>Можно скачать уже <a href=https://github.com/firecracker-microvm/firecracker/blob/master/docs/getting-started.md>готовое ядро</a>;</li><li>Можно собрать <a href=https://github.com/firecracker-microvm/firecracker/blob/master/docs/rootfs-and-kernel-setup.md>вручную свое ядро</a>.</li></ul><p>Разберем второй вариант.</p><p><a href=https://linuxhint.com/compile-linux-kernel-centos7/>По данной ссылке</a> подготовим рабочее окружение и загрузим последнею версию ядра.</p><pre><code>sudo yum install flex flex-devel bison bison-devel ncurses-devel make gcc bc openssl-devel elfutils-libelf-devel rpm-build

wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.6.13.tar.xz
tar xvf linux-5.6.13.tar.xz

cd linux-5.6.13
curl https://raw.githubusercontent.com/firecracker-microvm/firecracker/master/resources/microvm-kernel-x86_64.config -o .config

make menuconfig
</code></pre><p>Ничего не выбираем, просто сохраняем конфиг как .config</p><pre><code>make vmlinux
</code></pre><p>Скопируем полученный файл в каталог /var/lib/firecracker/kernels/</p><pre><code>sudo cp ./vmlinux /var/lib/firecracker/kernels/vmlinux-5.6.13
</code></pre><p>Теперь мы можем организовать целый каталог ядер, который может быть использован под различные задачи с различными требованиями.</p><h2 id=сборка-корневой-системы>Сборка корневой системы</h2><p>Нам понадобится корневая система. Варианты:</p><ul><li>Можно скачать уже <a href=(https://github.com/firecracker-microvm/firecracker/blob/master/docs/getting-started.md)>готовую корневую систему</a>;</li><li>Можно собрать <a href=http://www.forevergenin.com/posts/linux/bootstrapping-centos-rootfs/>вручную свою корневую систему</a>.</li></ul><p>Разберем второй вариант.</p><h3 id=сборка-корневой-системы-centos>Сборка корневой системы CentOS</h3><p>В данной сборке будет минимальная система CentOS, включая <strong>systemd-networkd</strong> и <strong>openssh-server</strong>. Эти пакеты необходимы, чтобы виртуальная машина запускалась с настроенной сетью и серверов openssh для удаленного доступа.</p><p>Подготовим рабочее окружение</p><pre><code>cd
mkdir myrootfs
cat&lt;&lt;EOF | tee chroot-centos7.repo
[centos7-chroot-base]
name=CentOS-7-Base
baseurl=http://mirror.centos.org/centos/7/os/x86_64
gpgcheck=0
[centos7-chroot-epel]
name=Extra Packages for Enterprise Linux 7
baseurl=http://dl.fedoraproject.org/pub/epel/7/x86_64
gpgcheck=0
EOF
</code></pre><p>Установим минимальный набор пакетов</p><pre><code>sudo yum -y -c chroot-centos7.repo --disablerepo=* --enablerepo=centos7-chroot-base --enablerepo=centos7-chroot-epel --disableplugin=* --installroot=/home/nurmukhamed/myrootfs install \
	bash \
	bash-completion \
	vim-minimal \
	yum \
	iproute \
	iputils \
	rootfiles \
	sudo \
    systemd-networkd \
    openssh-server \
    openssh
</code></pre><p>Подготовка к chroot</p><pre><code>sudo mount --bind /dev ~/myrootfs/dev
sudo mount --bind /dev/pts ~/myrootfs/dev/pts
sudo mount --bind /sys ~/myrootfs/sys
sudo mount --bind /proc ~/myrootfs/proc
sudo cp /etc/resolv.conf ~/myrootfs/etc/
</code></pre><p>Chroot</p><pre><code>sudo bash
cd ~/myrootfs
chroot ~/myrootfs

</code></pre><p>Внутри chroot</p><pre><code>echo &quot;7&quot; &gt; /etc/yum/vars/releasever
echo &quot;x86_64&quot; &gt; /etc/yum/vars/basearch

yum update -y 

yum clean all
rm -rf /boot /var/cache/yum/*

systemd-tmpfiles --create --boot
rm -f /var/run/nologin

echo 'firecracker' &gt; /etc/yum/vars/infra

awk '(NF==0&amp;&amp;!done){print &quot;override_install_langs='$LANG'\ntsflags=nodocs&quot;;done=1}{print}' \
    &lt; /etc/yum.conf &gt; /etc/yum.conf.new
mv /etc/yum.conf.new /etc/yum.conf

rm -f /usr/lib/locale/locale-archive

#Setup locale properly
localedef -v -c -i en_US -f UTF-8 en_US.UTF-8
/bin/date +%Y%m%d_%H%M &gt; /etc/BUILDTIME

# Create folder for systemd-networkd service
mkdir /etc/systemd/network

:&gt; /etc/machine-id

exit
</code></pre><p>Отключаем разделы</p><pre><code>sudo rm ~/myrootfs/etc/resolv.conf
sudo umount ~/myrootfs/dev/pts
sudo umount ~/myrootfs/dev
sudo umount ~/myrootfs/sys
sudo umount ~/myrootfs/proc
</code></pre><p>Чистка</p><pre><code>sudo rm -rf ~/myrootfs/boot
sudo rm -rf ~/myrootfs/var/cache/yum/*
sudo rm -f ~/myrootfs/tmp/ks-script*
sudo rm -rf ~/myrootfs/var/log/*
sudo rm -rf ~/myrootfs/tmp/*
sudo rm -rf ~/myrootfs/etc/sysconfig/network-scripts/ifcfg-*
</code></pre><p>Произведем упаковку образа</p><pre><code>sudo tar -Jcvf /var/lib/firecracker/rootfs/centos7-$(/bin/date +%Y%m%d).tar.xz -C ~/myrootfs .
</code></pre><p>Теперь у нас имеется образ ОС CentOS, который мы можем развернуть в любой момент.</p><h3 id=сборка-корневой-системы-debian-buster>Сборка корневой системы Debian Buster</h3><p>В данной сборке будет минимальная система Debian. Основной послужила <a href=https://habr.com/ru/post/147522/>следующая статья</a>.</p><p>Подготовим рабочее окружение</p><pre><code>sudo yum install debootstrap -y
mkdir ~/debian

sudo debootstrap --include=sudo,nano,wget --arch amd64 buster ~/debian http://mirror.neolabs.kz/debian/

sudo mount -o bind /dev ~/debian/dev
sudo mount -o bind /sys ~/debian/sys
sudo mount -o bind /proc ~/debian/proc

cat&lt;&lt;EOF | sudo tee ~/debian/etc/resolv.conf
search lan
nameserver 192.168.1.1
EOF
</code></pre><p>Рабочий вариант /etc/apt/source.list</p><pre><code>cat&lt;&lt;EOF| sudo tee ~/debian/etc/apt/source.list
deb http://mirror.neolabs.kz/debian/ buster main contrib non-free
deb-src http://mirror.neolabs.kz/debian/ stretch main contrib non-free

deb http://mirror.neolabs.kz/debian/ buster-updates main contrib non-free
deb-src http://mirror.neolabs.kz/debian/ buster-updates main contrib non-free

deb http://security.debian.org/debian-security/ buster/updates main contrib non-free
deb-src http://security.debian.org/debian-security/ buster/updates main contrib non-free
EOF
</code></pre><p>Скрипт постустановки</p><pre><code>cat&lt;&lt;EOF| sudo tee ~/debian/postinstall.sh
#!/bin/bash

## обновление индекса репозитария
apt-get update

## настройка часовых поясов
dpkg-reconfigure tzdata

## участие в опросе популярности пакетов
apt-get -y install popularity-contest

## русский язык в консоли, русская локаль
## при настройке console-cyrillic лучше выбрать, как шрифт, UniCyr, а на последний вопрос ответить «Да»

apt-get -y install locales console-cyrillic
dpkg-reconfigure locales
dpkg-reconfigure console-cyrillic
EOF
</code></pre><p>Запустим скрипт в chroot</p><pre><code>env LANG=C env HOME=/root sudo -E chroot ~/debian /bin/bash /postinstall.sh
</code></pre><p>Отключаем разделы</p><pre><code>sudo rm ~/debian/etc/resolv.conf
sudo umount ~/debian/dev
sudo umount ~/debian/sys
sudo umount ~/debian/proc
</code></pre><p>Произведем упаковку образа</p><pre><code>sudo tar -Jcvf /var/lib/firecracker/rootfs/debian-buster-$(/bin/date +%Y%m%d).tar.xz -C ~/debian .
</code></pre><p>Теперь у нас имеется образ ОС Debian, который мы можем развернуть в любой момент.</p><h3 id=todo---сборка-корневой-системы-ubuntu>TODO - Сборка корневой системы Ubuntu</h3><h2 id=создание-параметризированной-службы-systemd>Создание параметризированной службы systemd</h2><p>На данный момент у нас имеются:</p><ul><li>Пакет firecracker-binary;</li><li>Собранное ядро linux 5.6.13;</li><li>Собранная корневая система ОС CentOS 7.</li></ul><p>Теперь мы можем приступить к запуску первой виртуальной машины в firecracker.</p><p>Имя виртуальной машины: testcentos</p><pre><code>sudo systemctl enable firecracker@testcentos.service
</code></pre><p>Наша параметризированная служба теперь будет искать файл /etc/firecracker/testcentos.json.
В этом файле будут описаны параметры виртуальной машины</p><h2 id=шаблон-виртуальной-машины>Шаблон виртуальной машины</h2><p>Параметры нашей виртуальной машины:</p><table><thead><tr><th>Параметр</th><th>Значение</th></tr></thead><tbody><tr><td>CPU</td><td>2</td></tr><tr><td>RAM</td><td>1024MB</td></tr><tr><td>Hyper-Thread</td><td>false</td></tr><tr><td>Kernel Path</td><td>/var/lib/firecracker/kernels/vmlinux-5.6.13</td></tr><tr><td>RootFS Image</td><td>/var/lib/firecracker/rootfs/centos7-20200518.tar.xz</td></tr><tr><td>RootFS Path</td><td>/var/lib/firecracker/microvm/testcentos.ext4</td></tr><tr><td>RootFS Size</td><td>8GB</td></tr><tr><td>NIC</td><td>eth0</td></tr><tr><td>IP-address</td><td>172.16.0.2</td></tr></tbody></table><p>Для запуска виртуальной машины нам необходимо развернуть образ ОС CentOS.</p><pre><code>sudo dd if=/dev/zero of=/var/lib/firecracker/microvm/testcentos.ext4 bs=1M count=8192
sudo mkfs.ext4 /var/lib/firecracker/microvm/testcentos.ext4
sudo mkdir /tmp/testcentos
sudo mount -o loop /var/lib/firecracker/microvm/testcentos.ext4 /tmp/testcentos
sudo tar -Jxvf /var/lib/firecracker/rootfs/centos7-20200518.tar.xz -C /tmp/testcentos

</code></pre><p>Нужно сгенерировать пароль пользователя root. Установим пароль как &ldquo;MySecretPassword&rdquo;.</p><pre><code>sudo rm /tmp/testcentos/etc/shadow*

password=$(python -c &quot;import random,string,crypt;
randomsalt = ''.join(random.sample(string.ascii_letters,8));
print crypt.crypt('MySecretPassword', '\$6\$%s\$' % randomsalt)&quot;)

cat&lt;&lt;EOF| sudo tee /tmp/testcentos/etc/shadow
root:${password}:18353:0:99999:7:::
bin:*:18353:0:99999:7:::
daemon:*:18353:0:99999:7:::
adm:*:18353:0:99999:7:::
lp:*:18353:0:99999:7:::
sync:*:18353:0:99999:7:::
shutdown:*:18353:0:99999:7:::
halt:*:18353:0:99999:7:::
mail:*:18353:0:99999:7:::
operator:*:18353:0:99999:7:::
games:*:18353:0:99999:7:::
ftp:*:18353:0:99999:7:::
nobody:*:18353:0:99999:7:::
systemd-network:!!:18400::::::
dbus:!!:18400::::::
EOF

cat&lt;&lt;EOF| sudo tee /tmp/testcentos/etc/shadow-
root:${password}:18353:0:99999:7:::
bin:*:18353:0:99999:7:::
daemon:*:18353:0:99999:7:::
adm:*:18353:0:99999:7:::
lp:*:18353:0:99999:7:::
sync:*:18353:0:99999:7:::
shutdown:*:18353:0:99999:7:::
halt:*:18353:0:99999:7:::
mail:*:18353:0:99999:7:::
operator:*:18353:0:99999:7:::
games:*:18353:0:99999:7:::
ftp:*:18353:0:99999:7:::
nobody:*:18353:0:99999:7:::
systemd-network:!!:18400::::::
dbus:!!:18400::::::
EOF

sudo chown root:root /tmp/testcentos/etc/shadow*
sudo chmod 0000 /tmp/testcentos/etc/shadow*
</code></pre><p>Настройки сетевой карты</p><pre><code>cat&lt;&lt;EOF | sudo tee /tmp/testcentos/etc/systemd/network/20-wired.network
[Match]
Name=eth0

[Network]
Address=172.16.0.2/24
Gateway=172.16.0.1
DNS=8.8.8.8
EOF
</code></pre><pre><code>sudo umount /tmp/testcentos
sudo rmdir /tmp/testcentos
</code></pre><p>Образ развернут, теперь нужна <a href=https://github.com/firecracker-microvm/firecracker/blob/master/tests/framework/vm_config.json>конфигурация виртуальной машины</a>. Наша тестовая конфигурация будет выглядет так:</p><pre><code>macaddress=$(echo 00:60:2F:$[RANDOM%10]$[RANDOM%10]:$[RANDOM%10]$[RANDOM%10]:$[RANDOM%10]$[RANDOM%10])
cat&lt;&lt;EOF | sudo tee /etc/firecracker/testcentos.json
{
  &quot;boot-source&quot;: {
    &quot;kernel_image_path&quot;: &quot;/var/lib/firecracker/kernels/vmlinux-5.6.13&quot;,
    &quot;boot_args&quot;: &quot;console=ttyS0 reboot=k panic=1 pci=off&quot;
  },
  &quot;drives&quot;: [
    {
      &quot;drive_id&quot;: &quot;rootfs&quot;,
      &quot;path_on_host&quot;: &quot;/var/lib/firecracker/microvm/testcentos.ext4&quot;,
      &quot;is_root_device&quot;: true,
      &quot;is_read_only&quot;: false
    }
  ],
  &quot;machine-config&quot;: {
    &quot;vcpu_count&quot;: 2,
    &quot;mem_size_mib&quot;: 1024,
    &quot;ht_enabled&quot;: false
  },
  &quot;network-interfaces&quot;: [ 
      {
      &quot;iface_id&quot;: &quot;eth0&quot;,
      &quot;guest_mac&quot;: &quot;${macaddress}&quot;,
      &quot;host_dev_name&quot;: &quot;testcentos&quot;
    }
  ],
  &quot;actions&quot;: {
      &quot;action_type&quot;: &quot;InstanceStart&quot;
  }
}
EOF
</code></pre><p>Также нам понадобится <a href=https://superuser.com/questions/218340/how-to-generate-a-valid-random-mac-address-with-bash-shell>генератор MAC-адресов</a> для генерации случайных MAC-адресов. В данной статье я не буду проверять на уникальность полученные адреса. <strong>А вы должны!</strong></p><p>Конфигурация сетевой карты будет далее.</p><h2 id=настройка-сети>Настройка сети</h2><p>Более подробно настройка сети для firecracker приведена <a href=https://github.com/firecracker-microvm/firecracker/blob/master/docs/network-setup.md>здесь</a>.</p><pre><code>sudo ip tuntap add testcentos mode tap
sudo ip addr add 172.16.0.1/24 dev testcentos
sudo ip link set testcentos up
</code></pre><h2 id=настройка-firewalld>Настройка firewalld</h2><p>Используйте firewalld, забудьте про iptables править вручную.</p><pre><code>sudo firewall-cmd --new-zone=testcentos --permanent
sudo firewall-cmd --reload
sudo firewall-cmd --zone=testcentos --change-interface=testcentos
sudo firewall-cmd --zone=testcentos --add-service=ssh
sudo firewall-cmd --zone=public --add-masquerade
</code></pre><p>В данной конфигурации, настройки firewalld будут работать до перегрузки системы.</p><h2 id=запуск-виртуальной-машины>Запуск виртуальной машины</h2><pre><code>sudo systemctl start firecracker@testcentos.service
</code></pre><p>В случае ошибки, можно посмотреть логи системы</p><pre><code>sudo journalctl -u firecracker@testcentos.service
</code></pre><h2 id=todo-автоматизация-действий>TODO Автоматизация действий</h2><p>Теперь у нас появилась возможность для автоматизации наших действий и программно запускать виртуальные машины в firecracker.</p><p>Представим, что у нас имеется рабочий CI/CD, например, Gitlab. Тогда мы можем добавить в него еще 3 pipeline:</p><ul><li>Сборка ядер, по мере выхода новых ядер или исправления критических уязвимостей;</li><li>Сборка образов корневых систем;</li><li>Создание виртуальной машины с заданными параметрами.</li></ul><h2 id=todo-примеры>TODO Примеры:</h2><h3 id=todo-ubuntu>TODO Ubuntu</h3><h2 id=дальнейшие-действия>Дальнейшие действия.</h2><p><strong>UPDATE: 14-08-2020</strong> Вышла новая статья как <a href=https://www.hdfilm.kz/install-kubernetes-using-rke-on-firecracker-virt>поднять кластер Kubernetes поверх Firecracker, используя rke</a></p></div><footer class=entry-footer><div class="container sep-before"><div class=categories><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5A2 2 0 014 3H9l2 3h9a2 2 0 012 2z"/></svg><span class=screen-reader-text>categories: </span><a class=category href=/blog/category/linux/>linux</a>, <a class=category href=/blog/category/centos/>centos</a>, <a class=category href=/blog/category/amazon/>amazon</a>, <a class=category href=/blog/category/virtualization/>virtualization</a>, <a class=category href=/blog/category/kvm/>kvm</a>, <a class=category href=/blog/category/firecracker/>firecracker</a>, <a class=category href=/blog/category/systemd/>systemd</a>, <a class=category href=/blog/category/manual/>manual</a></div></div></footer></article><nav class=entry-nav><div class=container><div class="prev-entry sep-before"><a href=/blog/2020/02/03/setting-suricata-ids-ips-system/><span aria-hidden=true><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="20" y1="12" x2="4" y2="12"/><polyline points="10 18 4 12 10 6"/></svg></span><span class=screen-reader-text>: </span>Настройка Suricata на CentOS 7</a></div><div class="next-entry sep-before"><a href=/blog/2020/05/20/lost-nic-after-kernel-upgrade/><span class=screen-reader-text>: </span>Пропала сеть при обновление ядра kernel-ml<span aria-hidden=true><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><line x1="4" y1="12" x2="20" y2="12"/><polyline points="14 6 20 12 14 18"/></svg></span></a></div></div></nav><section id=comments class=comments><div class="container sep-before"><div class=comments-area><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"hdfilm-2"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></section></main><footer id=footer class=footer><div class="container sep-before"><section class="widget widget-social_menu sep-after"><nav aria-label><ul><li><a href=https://github.com/Nurmukhamed target=_blank rel=noopener><span class=screen-reader-text></span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></li><li><a href=mailto:nurmukhamed.artykaly@hdfilm.kz target=_blank rel=noopener><span class=screen-reader-text></span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></a></li><li><a href=https://t.me/nartykaly target=_blank rel=noopener><span class=screen-reader-text></span><svg class="icon" viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="m22.05 1.577c-.393-.016-.784.08-1.117.235-.484.186-4.92 1.902-9.41 3.64C9.263 6.325 7.005 7.198 5.267 7.867 3.53 8.537 2.222 9.035 2.153 9.059c-.46.16-1.082.362-1.61.984-.79581202 1.058365.21077405 1.964825 1.004 2.499 1.76.564 3.58 1.102 5.087 1.608.556 1.96 1.09 3.927 1.618 5.89.174.394.553.54.944.544l-.002.02s.307.03.606-.042c.3-.07.677-.244 1.02-.565.377-.354 1.4-1.36 1.98-1.928l4.37 3.226.035.02s.484.34 1.192.388c.354.024.82-.044 1.22-.337.403-.294.67-.767.795-1.307.374-1.63 2.853-13.427 3.276-15.38L23.676 4.725C23.972 3.625 23.863 2.617 23.18 2.02 22.838 1.723 22.444 1.593 22.05 1.576z"/></svg></a></li></ul></nav></section><div class=copyright><p>&copy; 2009-2023 Nurmukhamed Artykaly</p></div></div></footer></div></div><script>window.__assets_js_src="/assets/js/"</script><script src=/assets/js/main.67d669ac.js></script><script src=/js/custom.js></script></body></html>