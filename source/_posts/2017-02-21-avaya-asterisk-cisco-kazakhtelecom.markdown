---
layout: post
title: "Cisco VOIP - учимся писать dialplan, dialpeer"
date: 2017-02-21 12:30:30 +0600
comments: true
published: true
categories: 
- cisco
- avaya defenity
- asterisk
- Kazakhtelecom
- E1 channel
---

В данной статье о моем опыте настройки Cisco 2811 в связке с Asterisk и Avaya Defenity. Черновик статьи лежал у меня в течение года. Решил опубликовать сегодня <!--more-->

##Предыстория: 

В далеких 2007-2009 годах, в одном офисе стояла АТС Avaya, подключенная Е1-потоком к Казахтелекому. В один день руководство решило, что нужно настроить «железную тетку», голосовую почту, конференции, дешевые тарифы через VOIP-провайдеров. В качестве дешевого решения предложил к АТС подключить Asterisk и на базе Asterisk реализовать умный функционал АТС.  В качестве sip-e1-шлюза был выбран роутер Cisco 2811 + 2Е1. В то время я еще не знал, что есть такая замечательная компания [Парабел](http://www.parabel.ru), которая выпускает не дорогие E1-платы для Asteriskа.

****Входные данные:****

****Казахтелеком:****

- Количество е1-потоков – 1, 30 каналов;
- Количество телефонных номеров – 2;
- Номер – 252525;
- Номер – 363636;
- Plan – national;
- Type – isdn.

****Avaya:****

- Количество внутренних линий – 96 (макс);
- Количество потоков е1 – 1;

****Cisco:****

- Количество PVDM2-32 – 2;
- Количество потоков е1 – 2;

****Номерной план офиса:****

- 10ХХ,11XX – номера на АТС Avaya;
- 12XX – номера на Asterisk;
- 252525 – входящий номер для IVR;
- 363636 – входящий номер на ресепшн;
- 1ХХ – экстренные и служебные номера Казахтелекома;
- 2ХХХХХХ, 3ХХХХХХ – исходящий звонок в город;
- 8ХХХХХХХХХХ – исходящий междугородний звонок в РК и РФ;
- 810. – исходящий международный звонок.

****Задача:****

****Настроить Cisco следующим образом:****

- При звонке на номер 252525, отправлять звонок на asterisk, на «железную тетку»;
- При звонке на номер 363636, отправлять звонок на avaya, на ресепшн;
- При звонке с АТС на Астериск, отправлять звонок на asterisk;
- При звонке с Asterisk на АТС, отправлять звонок на Avaya;
- При звонке с АТС  в город – отправлять звонок на Казахтелеком;
- При звонке с АТС на межгород – отправлять звонки на Asterisk, если Asterisk не доступен, отправлять звонки на Казахтелеком;

****Грабли:****

- Основной проблемой было понять, как работают dial-peer в cisco. Чтение google дало основную информацию, но ее было не достаточно;
- В asterisk есть понятие context для транка, любой входящий вызов идет в этот контекст, где происходит обработка звонка. В циске такого понятия нет. Нужно уметь отлавливать входящие звонки;
- В чем различие между calling number (набирающий? номер) и called number(набранный номер);


****Решение:****

- Использовать трансляцию номеров при входящем звонке на каждом е1-потоке:
	- Казахтелеком – добавить 11111 к набранному номеру;
	- Avaya – добавить 22222 к набранному номеру;
- Использовать трансляцию номеров при исходящем звонке на каждом е1-потоке:
	- Казахтелеком – отнять 33333 с набранного номера;
	- Avaya – отнять 44444 с набранного номера;
- Использовать "incoming called-number" для входящего dial-peer;
	- 252525, чтобы найти звонок с Е1-потока, передать дальше в Астериск;
    - 363636, чтобы найти звонок с Е1-потока, передать дальше в Аваю;
    - 12ХХ, 
    
В визио составил описание процесса звонка в cisco. 

{% img https://s3-eu-west-1.amazonaws.com/images.hdfilm.kz/kazakhtelecom-incoming.png %}

****TODO****: дописать статью